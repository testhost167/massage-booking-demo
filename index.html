<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Massage Booking Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Simple styling -->
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }

    .app-container {
      max-width: 800px;
      width: 100%;
      background: #ffffff;
      border-radius: 12px;
      padding: 20px 24px 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }

    h1 {
      margin-top: 0;
      font-size: 1.6rem;
      color: #333;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 20px;
      align-items: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.9rem;
    }

    .control-group label {
      font-weight: 600;
      color: #555;
    }

    input[type="date"],
    select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
    }

    .slots-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
    }

    .slot-btn {
      padding: 8px 4px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.1s;
    }

    .slot-available {
      background: #e6f7ec;
      color: #166534;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    .slot-available:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.12);
    }

    .slot-unavailable {
      background: #eeeeee;
      color: #888;
      cursor: not-allowed;
    }

    .legend {
      margin-top: 16px;
      font-size: 0.85rem;
      color: #555;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-box {
      width: 14px;
      height: 14px;
      border-radius: 4px;
    }

    .legend-available {
      background: #e6f7ec;
      border: 1px solid #a7e1be;
    }

    .legend-unavailable {
      background: #eeeeee;
      border: 1px solid #cccccc;
    }

    .bookings-list {
      margin-top: 24px;
      border-top: 1px solid #eee;
      padding-top: 16px;
    }

    .bookings-list h2 {
      font-size: 1.1rem;
      margin: 0 0 8px;
    }

    .booking-item {
      font-size: 0.9rem;
      color: #444;
      margin-bottom: 4px;
    }

    .no-bookings {
      font-size: 0.9rem;
      color: #999;
    }

    .message {
      margin-top: 12px;
      font-size: 0.9rem;
    }

    .message.success {
      color: #15803d;
    }

    .message.error {
      color: #b91c1c;
    }
  </style>

  <!-- React & ReactDOM via CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel so we can write JSX directly in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div class="app-container">
    <div id="root"></div>
  </div>

<script type="text/babel">
  const { useState, useMemo } = React;

  // ---- CONFIG ----
  const THERAPISTS = 3;
  const OPEN_HOUR = 9;      // 9:00
  const OPEN_MIN = 30;      // 9:30
  const CLOSE_HOUR = 22;    // 10 PM
  const SLOT_MINUTES = 30;  // 30-minute blocks

  const totalMinutes = (CLOSE_HOUR * 60) - (OPEN_HOUR * 60 + OPEN_MIN);
  const TOTAL_SLOTS = totalMinutes / SLOT_MINUTES; // 25 slots

  function indexToLabel(index) {
    const startMinutes = (OPEN_HOUR * 60 + OPEN_MIN) + index * SLOT_MINUTES;
    let h = Math.floor(startMinutes / 60);
    let m = startMinutes % 60;
    const suffix = h >= 12 ? "PM" : "AM";
    if (h === 0) h = 12;
    if (h > 12) h -= 12;
    const mm = m.toString().padStart(2, "0");
    return `${h}:${mm} ${suffix}`;
  }

  function getTodayISO() {
    const d = new Date();
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
  }

  // Each booking: { date, startIndex, durationMinutes, name, phone }
  function BookingApp() {
    const [selectedDate, setSelectedDate] = useState(getTodayISO());
    const [durationMinutes, setDurationMinutes] = useState(60);
    const [bookings, setBookings] = useState([]);
    const [message, setMessage] = useState(null); // { type, text }

    // NEW: customer info
    const [customerName, setCustomerName] = useState("");
    const [phone, setPhone] = useState("");

    const durationSlots = durationMinutes / SLOT_MINUTES;

    // Build availability map for selected date
    const slotAvailability = useMemo(() => {
      const counts = new Array(TOTAL_SLOTS).fill(0);

      bookings
        .filter(b => b.date === selectedDate)
        .forEach(b => {
          const neededSlots = b.durationMinutes / SLOT_MINUTES;
          for (let i = b.startIndex; i < b.startIndex + neededSlots && i < TOTAL_SLOTS; i++) {
            counts[i] += 1;
          }
        });

      const result = [];
      for (let i = 0; i < TOTAL_SLOTS; i++) {
        const label = indexToLabel(i);

        if (i + durationSlots > TOTAL_SLOTS) {
          result.push({ index: i, label, available: false });
          continue;
        }

        let canBook = true;
        for (let j = i; j < i + durationSlots; j++) {
          if (counts[j] >= THERAPISTS) {
            canBook = false;
            break;
          }
        }

        result.push({ index: i, label, available: canBook });
      }

      return result;
    }, [bookings, selectedDate, durationSlots]);

    function handleBook(startIndex) {
      // NEW: require name + phone
      if (!customerName.trim() || !phone.trim()) {
        setMessage({
          type: "error",
          text: "Please enter your name and phone number before booking.",
        });
        return;
      }

      const newBooking = {
        date: selectedDate,
        startIndex,
        durationMinutes: durationMinutes,
        name: customerName.trim(),
        phone: phone.trim(),
      };

      // Rebuild occupancy for safety
      const counts = new Array(TOTAL_SLOTS).fill(0);
      bookings
        .filter(b => b.date === selectedDate)
        .forEach(b => {
          const neededSlots = b.durationMinutes / SLOT_MINUTES;
          for (let i = b.startIndex; i < b.startIndex + neededSlots && i < TOTAL_SLOTS; i++) {
            counts[i] += 1;
          }
        });

      const neededSlots = newBooking.durationMinutes / SLOT_MINUTES;
      for (let i = newBooking.startIndex; i < newBooking.startIndex + neededSlots; i++) {
        if (i >= TOTAL_SLOTS || counts[i] >= THERAPISTS) {
          setMessage({
            type: "error",
            text: "Sorry, that time range just became fully booked. Please pick another slot.",
          });
          return;
        }
      }

      setBookings(prev => [...prev, newBooking]);
      setMessage({
        type: "success",
        text: `Booked ${durationMinutes}-minute massage at ${indexToLabel(startIndex)} on ${selectedDate} for ${newBooking.name}.`,
      });
    }

    const bookingsForDate = bookings
      .filter(b => b.date === selectedDate)
      .sort((a, b) => a.startIndex - b.startIndex);

    return (
      <div>
        <h1>Massage Booking (Demo)</h1>

        <div className="controls">
          <div className="control-group">
            <label htmlFor="name">Your name</label>
            <input
              id="name"
              type="text"
              placeholder="e.g. Alice Chen"
              value={customerName}
              onChange={e => setCustomerName(e.target.value)}
            />
          </div>

          <div className="control-group">
            <label htmlFor="phone">Phone</label>
            <input
              id="phone"
              type="tel"
              placeholder="e.g. 555-123-4567"
              value={phone}
              onChange={e => setPhone(e.target.value)}
            />
          </div>

          <div className="control-group">
            <label htmlFor="date">Date</label>
            <input
              id="date"
              type="date"
              value={selectedDate}
              onChange={e => setSelectedDate(e.target.value)}
            />
          </div>

          <div className="control-group">
            <label htmlFor="duration">Session length</label>
            <select
              id="duration"
              value={durationMinutes}
              onChange={e => setDurationMinutes(Number(e.target.value))}
            >
              <option value={30}>30 minutes</option>
              <option value={60}>60 minutes</option>
              <option value={90}>90 minutes</option>
            </select>
          </div>
        </div>

        <div className="slots-grid">
          {slotAvailability.map(slot => (
            <button
              key={slot.index}
              className={
                "slot-btn " +
                (slot.available ? "slot-available" : "slot-unavailable")
              }
              disabled={!slot.available}
              onClick={() => handleBook(slot.index)}
            >
              {slot.label}
            </button>
          ))}
        </div>

        <div className="legend">
          <div className="legend-item">
            <div className="legend-box legend-available" /> Available
          </div>
          <div className="legend-item">
            <div className="legend-box legend-unavailable" /> Unavailable (all 3 therapists busy)
          </div>
        </div>

        {message && (
          <div className={`message ${message.type}`}>
            {message.text}
          </div>
        )}

        <div className="bookings-list">
          <h2>Bookings on {selectedDate}</h2>
          {bookingsForDate.length === 0 ? (
            <div className="no-bookings">No bookings yet for this date.</div>
          ) : (
            bookingsForDate.map((b, idx) => (
              <div key={idx} className="booking-item">
                • {indexToLabel(b.startIndex)} – {b.durationMinutes} minutes — {b.name} ({b.phone})
              </div>
            ))
          )}
        </div>
      </div>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById("root"));
  root.render(<BookingApp />);
</script>

</body>
</html>
